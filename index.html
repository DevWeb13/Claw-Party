<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Claw Party - Jeu de pince multijoueur</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
      @keyframes clawDown {
        0% {
          transform: translateY(0);
        }
        100% {
          transform: translateY(40px);
        }
      }
      @keyframes clawUp {
        0% {
          transform: translateY(40px);
        }
        100% {
          transform: translateY(0);
        }
      }
      @keyframes shake {
        0% {
          transform: rotate(-2deg);
        }
        50% {
          transform: rotate(2deg);
        }
        100% {
          transform: rotate(-2deg);
        }
      }
      .claw-down {
        animation: clawDown 0.3s forwards;
      }
      .claw-up {
        animation: clawUp 0.3s forwards;
      }
      .plush-shake {
        animation: shake 0.5s infinite;
      }
      .plush-caught {
        transition: all 0.3s ease-out;
        transform: translateY(-100px);
        opacity: 0;
      }
      .game-area {
        aspect-ratio: 1 / 1;
      }
      @media (max-width: 640px) {
        .game-area {
          width: 100%;
          height: auto;
        }
      }
    </style>
  </head>
  <body
    class="bg-purple-100 min-h-screen flex flex-col items-center justify-center p-4"
  >
    <!-- Écran d'accueil -->
    <div
      id="home-screen"
      class="bg-white rounded-xl shadow-xl p-6 max-w-md w-full"
    >
      <h1 class="text-3xl font-bold text-center text-purple-600 mb-6">
        Claw Party
      </h1>

      <div class="mb-4">
        <label class="block text-gray-700 mb-2">Pseudo</label>
        <input
          id="username"
          type="text"
          class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
          placeholder="Votre pseudo"
        />
      </div>

      <div class="mb-6">
        <label class="block text-gray-700 mb-2">Couleur de votre pince</label>
        <div class="flex gap-2">
          <button
            data-color="red"
            class="w-8 h-8 rounded-full bg-red-500 border-2 border-transparent hover:border-black"
          ></button>
          <button
            data-color="blue"
            class="w-8 h-8 rounded-full bg-blue-500 border-2 border-transparent hover:border-black"
          ></button>
          <button
            data-color="green"
            class="w-8 h-8 rounded-full bg-green-500 border-2 border-transparent hover:border-black"
          ></button>
          <button
            data-color="yellow"
            class="w-8 h-8 rounded-full bg-yellow-500 border-2 border-transparent hover:border-black"
          ></button>
          <button
            data-color="purple"
            class="w-8 h-8 rounded-full bg-purple-500 border-2 border-transparent hover:border-black"
          ></button>
        </div>
      </div>

      <div class="flex flex-col gap-4">
        <button
          id="host-game"
          class="bg-purple-600 hover:bg-purple-700 text-white py-3 px-6 rounded-lg font-semibold transition"
        >
          Créer une partie
        </button>
        <div class="relative">
          <input
            id="join-id"
            type="text"
            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
            placeholder="ID de partie"
          />
          <button
            id="join-game"
            class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-purple-600 hover:bg-purple-700 text-white py-1 px-4 rounded-lg text-sm"
          >
            Rejoindre
          </button>
        </div>
      </div>

      <div id="host-info" class="mt-4 hidden bg-purple-100 p-3 rounded-lg">
        <p class="text-purple-800">
          Partagez cet ID : <span id="game-id" class="font-bold"></span>
        </p>
        <p class="text-sm text-purple-600">En attente d'un joueur...</p>
      </div>
    </div>

    <!-- Écran de jeu -->
    <div id="game-screen" class="hidden w-full max-w-2xl">
      <div class="flex justify-between items-center mb-4">
        <div id="player-info" class="flex gap-4">
          <div id="player1-info" class="flex items-center gap-2">
            <div id="player1-color" class="w-4 h-4 rounded-full"></div>
            <span id="player1-name" class="font-semibold"></span>
            <span id="player1-score" class="font-bold">0</span>
          </div>
          <div id="player2-info" class="flex items-center gap-2 hidden">
            <div id="player2-color" class="w-4 h-4 rounded-full"></div>
            <span id="player2-name" class="font-semibold"></span>
            <span id="player2-score" class="font-bold">0</span>
          </div>
        </div>
        <div
          id="timer"
          class="text-xl font-bold bg-purple-600 text-white px-4 py-1 rounded-full"
        >
          60
        </div>
      </div>

      <div
        class="relative game-area bg-purple-200 rounded-lg overflow-hidden border-4 border-purple-300"
      >
        <!-- Zone de jeu avec peluches -->
        <div id="game-area" class="w-full h-full relative">
          <!-- Les peluches seront ajoutées dynamiquement ici -->
        </div>

        <!-- Pinces des joueurs -->
        <div
          id="claw1"
          class="absolute top-0 left-1/2 transform -translate-x-1/2"
        >
          <div class="w-8 h-10 bg-gray-400 rounded-t-full relative">
            <div
              class="absolute bottom-0 left-1/2 transform -translate-x-1/2 w-12 h-2 bg-gray-600"
            ></div>
            <div
              class="absolute bottom-2 left-1/2 transform -translate-x-1/2 w-6 h-6 rounded-full border-2 border-gray-700 claw-open"
            ></div>
          </div>
        </div>

        <div
          id="claw2"
          class="absolute top-0 left-1/2 transform -translate-x-1/2 hidden"
        >
          <div class="w-8 h-10 bg-gray-400 rounded-t-full relative">
            <div
              class="absolute bottom-0 left-1/2 transform -translate-x-1/2 w-12 h-2 bg-gray-600"
            ></div>
            <div
              class="absolute bottom-2 left-1/2 transform -translate-x-1/2 w-6 h-6 rounded-full border-2 border-gray-700 claw-open"
            ></div>
          </div>
        </div>
      </div>

      <div class="mt-4 flex justify-center">
        <button
          id="grab-button"
          class="bg-purple-600 hover:bg-purple-700 text-white py-4 px-8 rounded-lg font-bold text-xl transition w-full max-w-xs"
        >
          ATTRAPER
        </button>
      </div>

      <div
        id="message"
        class="mt-4 text-center text-lg font-semibold hidden"
      ></div>
    </div>

    <!-- Écran de fin de partie -->
    <div
      id="end-screen"
      class="hidden bg-white rounded-xl shadow-xl p-6 max-w-md w-full text-center"
    >
      <h2 id="end-title" class="text-2xl font-bold mb-4"></h2>
      <div id="scores" class="mb-6">
        <div class="flex justify-between mb-2">
          <span id="end-player1" class="font-semibold"></span>
          <span id="end-score1" class="font-bold"></span>
        </div>
        <div class="flex justify-between">
          <span id="end-player2" class="font-semibold"></span>
          <span id="end-score2" class="font-bold"></span>
        </div>
      </div>
      <button
        id="play-again"
        class="bg-purple-600 hover:bg-purple-700 text-white py-3 px-6 rounded-lg font-semibold transition w-full"
      >
        Rejouer
      </button>
    </div>

    <script>
      // Variables du jeu
      let gameState = {
        plushies: [],
        claw1: { x: 50, direction: 1, speed: 0.5, isDown: false, score: 0 },
        claw2: { x: 50, direction: 1, speed: 0.5, isDown: false, score: 0 },
        timeLeft: 60,
        gameInterval: null,
        isGameOver: false,
        playerColor: "red",
        playerName: "",
        isHost: false,
        peer: null,
        conn: null,
        otherPlayer: null,
      };

      // Éléments DOM
      const homeScreen = document.getElementById("home-screen");
      const gameScreen = document.getElementById("game-screen");
      const endScreen = document.getElementById("end-screen");
      const grabButton = document.getElementById("grab-button");
      const gameArea = document.getElementById("game-area");
      const claw1 = document.getElementById("claw1");
      const claw2 = document.getElementById("claw2");
      const timer = document.getElementById("timer");
      const message = document.getElementById("message");
      const player1Score = document.getElementById("player1-score");
      const player2Score = document.getElementById("player2-score");
      const player1Name = document.getElementById("player1-name");
      const player2Name = document.getElementById("player2-name");
      const player1Color = document.getElementById("player1-color");
      const player2Color = document.getElementById("player2-color");
      const player2Info = document.getElementById("player2-info");
      const hostInfo = document.getElementById("host-info");
      const gameId = document.getElementById("game-id");
      const endTitle = document.getElementById("end-title");
      const endPlayer1 = document.getElementById("end-player1");
      const endPlayer2 = document.getElementById("end-player2");
      const endScore1 = document.getElementById("end-score1");
      const endScore2 = document.getElementById("end-score2");

      // Initialisation
      document.addEventListener("DOMContentLoaded", () => {
        // Choix de la couleur
        document.querySelectorAll("[data-color]").forEach((btn) => {
          btn.addEventListener("click", () => {
            gameState.playerColor = btn.dataset.color;
            document.querySelectorAll("[data-color]").forEach((b) => {
              b.classList.remove("border-black");
              b.classList.add("border-transparent");
            });
            btn.classList.add("border-black");
            btn.classList.remove("border-transparent");
          });
        });

        // Créer une partie
        document.getElementById("host-game").addEventListener("click", () => {
          gameState.playerName =
            document.getElementById("username").value || "Joueur 1";
          gameState.isHost = true;
          setupPeer(true);
        });

        // Rejoindre une partie
        document.getElementById("join-game").addEventListener("click", () => {
          const joinId = document.getElementById("join-id").value.trim();
          if (joinId) {
            gameState.playerName =
              document.getElementById("username").value || "Joueur 2";
            setupPeer(false, joinId);
          }
        });

        // Bouton attraper
        grabButton.addEventListener("click", grabPlush);
        document.addEventListener("keydown", (e) => {
          if (e.code === "Space" && !gameScreen.classList.contains("hidden")) {
            grabPlush();
          }
        });

        // Rejouer
        document
          .getElementById("play-again")
          .addEventListener("click", resetGame);
      });

      // Configuration PeerJS
      function setupPeer(isHost, joinId = null) {
        gameState.peer = new Peer();

        gameState.peer.on("open", (id) => {
          if (isHost) {
            gameId.textContent = id;
            hostInfo.classList.remove("hidden");

            gameState.peer.on("connection", (connection) => {
              gameState.conn = connection;
              setupConnection();
            });
          } else {
            gameState.conn = gameState.peer.connect(joinId);
            setupConnection();
          }
        });

        gameState.peer.on("error", (err) => {
          console.error("PeerJS error:", err);
          showMessage("Erreur de connexion", "red-500");
        });
      }

      // Configuration de la connexion
      function setupConnection() {
        gameState.conn.on("open", () => {
          // Envoyer les infos du joueur
          gameState.conn.send({
            type: "player-info",
            name: gameState.playerName,
            color: gameState.playerColor,
          });

          // Démarrer le jeu
          startGame();
        });

        gameState.conn.on("data", (data) => {
          if (data.type === "player-info") {
            gameState.otherPlayer = {
              name: data.name,
              color: data.color,
            };
            updatePlayerInfo();
          } else if (data.type === "grab") {
            grabAnimation(2);
            checkPlushCollision(2, data.x);
          } else if (data.type === "plush-removed") {
            removePlush(data.id);
          } else if (data.type === "game-over") {
            endGame();
          }
        });

        gameState.conn.on("close", () => {
          showMessage("Joueur déconnecté", "red-500");
          setTimeout(() => {
            resetGame();
          }, 3000);
        });
      }

      // Démarrer le jeu
      function startGame() {
        homeScreen.classList.add("hidden");
        gameScreen.classList.remove("hidden");

        // Créer les peluches
        createPlushies();

        // Mettre à jour les infos joueurs
        updatePlayerInfo();

        // Démarrer le timer
        gameState.timeLeft = 60;
        timer.textContent = gameState.timeLeft;

        // Démarrer la boucle de jeu
        gameState.gameInterval = setInterval(updateGame, 16);

        // Démarrer le compte à rebours
        const countdown = setInterval(() => {
          gameState.timeLeft--;
          timer.textContent = gameState.timeLeft;

          if (gameState.timeLeft <= 0) {
            clearInterval(countdown);
            endGame();
          }
        }, 1000);
      }

      // Créer les peluches
      function createPlushies() {
        gameArea.innerHTML = "";
        gameState.plushies = [];

        const colors = [
          "red",
          "blue",
          "green",
          "yellow",
          "purple",
          "pink",
          "indigo",
        ];
        const sizes = ["w-10 h-10", "w-12 h-12", "w-14 h-14"];

        for (let i = 0; i < 20; i++) {
          const plush = document.createElement("div");
          const color = colors[Math.floor(Math.random() * colors.length)];
          const size = sizes[Math.floor(Math.random() * sizes.length)];

          // Position aléatoire dans la zone de jeu
          const left = 5 + Math.random() * 80;
          const top = 30 + Math.random() * 60;

          plush.className = `absolute rounded-full plush-shake ${size} bg-${color}-500 border-2 border-${color}-700 shadow-md`;
          plush.style.left = `${left}%`;
          plush.style.top = `${top}%`;
          plush.dataset.id = i;

          gameArea.appendChild(plush);
          gameState.plushies.push({
            id: i,
            element: plush,
            left: left,
            top: top,
            size: size,
            color: color,
          });
        }
      }

      // Mettre à jour les infos joueurs
      function updatePlayerInfo() {
        player1Name.textContent = gameState.playerName;
        player1Color.className = `w-4 h-4 rounded-full bg-${gameState.playerColor}-500`;

        if (gameState.otherPlayer) {
          player2Info.classList.remove("hidden");
          claw2.classList.remove("hidden");
          player2Name.textContent = gameState.otherPlayer.name;
          player2Color.className = `w-4 h-4 rounded-full bg-${gameState.otherPlayer.color}-500`;
        }
      }

      // Boucle de jeu principale
      function updateGame() {
        if (gameState.isGameOver) return;

        // Déplacer la pince du joueur 1
        gameState.claw1.x += gameState.claw1.direction * gameState.claw1.speed;
        if (gameState.claw1.x > 95 || gameState.claw1.x < 5) {
          gameState.claw1.direction *= -1;
        }
        claw1.style.left = `${gameState.claw1.x}%`;

        // Déplacer la pince du joueur 2 (si présent)
        if (gameState.otherPlayer) {
          gameState.claw2.x +=
            gameState.claw2.direction * gameState.claw2.speed;
          if (gameState.claw2.x > 95 || gameState.claw2.x < 5) {
            gameState.claw2.direction *= -1;
          }
          claw2.style.left = `${gameState.claw2.x}%`;
        }
      }

      // Attraper une peluche
      function grabPlush() {
        if (gameState.claw1.isDown || gameState.isGameOver) return;

        grabAnimation(1);
        checkPlushCollision(1, gameState.claw1.x);

        // Envoyer l'action au autre joueur
        if (gameState.conn && gameState.conn.open) {
          gameState.conn.send({
            type: "grab",
            x: gameState.claw1.x,
          });
        }
      }

      // Animation de la pince
      function grabAnimation(playerNum) {
        const claw = playerNum === 1 ? claw1 : claw2;
        const clawState = playerNum === 1 ? gameState.claw1 : gameState.claw2;

        clawState.isDown = true;
        claw.querySelector(".claw-open").classList.add("claw-down");
        claw.querySelector(".claw-open").classList.remove("claw-up");

        setTimeout(() => {
          claw.querySelector(".claw-open").classList.add("claw-up");
          claw.querySelector(".claw-open").classList.remove("claw-down");

          setTimeout(() => {
            clawState.isDown = false;
          }, 300);
        }, 500);
      }

      // Vérifier la collision avec une peluche
      function checkPlushCollision(playerNum, clawX) {
        const clawState = playerNum === 1 ? gameState.claw1 : gameState.claw2;
        const playerColor =
          playerNum === 1 ? gameState.playerColor : gameState.otherPlayer.color;

        setTimeout(() => {
          if (gameState.isGameOver) return;

          let caughtPlush = null;

          for (const plush of gameState.plushies) {
            // Vérifier si la pince est au-dessus de la peluche
            const xDiff = Math.abs(clawX - plush.left);
            const inRange = xDiff < 8; // Tolérance de collision

            if (inRange) {
              caughtPlush = plush;
              break;
            }
          }

          if (caughtPlush) {
            // Animation de la peluche attrapée
            caughtPlush.element.classList.remove("plush-shake");
            caughtPlush.element.classList.add("plush-caught");

            // Mettre à jour le score
            clawState.score++;
            if (playerNum === 1) {
              player1Score.textContent = clawState.score;
            } else {
              player2Score.textContent = clawState.score;
            }

            // Supprimer la peluche après l'animation
            setTimeout(() => {
              removePlush(caughtPlush.id);

              // Informer l'autre joueur
              if (gameState.conn && gameState.conn.open && playerNum === 1) {
                gameState.conn.send({
                  type: "plush-removed",
                  id: caughtPlush.id,
                });
              }
            }, 300);

            showMessage("Attrapé !", `${playerColor}-500`);
          } else {
            showMessage("Raté !", "gray-500");
          }
        }, 500); // Délai pour que la pince descende
      }

      // Supprimer une peluche
      function removePlush(id) {
        gameState.plushies = gameState.plushies.filter((plush) => {
          if (plush.id === id) {
            if (plush.element.parentNode) {
              plush.element.remove();
            }
            return false;
          }
          return true;
        });
      }

      // Afficher un message temporaire
      function showMessage(text, colorClass) {
        message.textContent = text;
        message.className = `mt-4 text-center text-lg font-semibold text-${colorClass}`;
        message.classList.remove("hidden");

        setTimeout(() => {
          message.classList.add("hidden");
        }, 1500);
      }

      // Fin de partie
      function endGame() {
        if (gameState.isGameOver) return;

        gameState.isGameOver = true;
        clearInterval(gameState.gameInterval);

        // Envoyer l'info de fin de partie à l'autre joueur
        if (gameState.conn && gameState.conn.open && gameState.isHost) {
          gameState.conn.send({
            type: "game-over",
          });
        }

        // Afficher l'écran de fin
        gameScreen.classList.add("hidden");
        endScreen.classList.remove("hidden");

        // Déterminer le gagnant
        endPlayer1.textContent = gameState.playerName;
        endScore1.textContent = gameState.claw1.score;

        if (gameState.otherPlayer) {
          endPlayer2.textContent = gameState.otherPlayer.name;
          endScore2.textContent = gameState.claw2.score;

          if (gameState.claw1.score > gameState.claw2.score) {
            endTitle.textContent = `${gameState.playerName} gagne !`;
          } else if (gameState.claw1.score < gameState.claw2.score) {
            endTitle.textContent = `${gameState.otherPlayer.name} gagne !`;
          } else {
            endTitle.textContent = "Égalité !";
          }
        } else {
          endPlayer2.textContent = "";
          endScore2.textContent = "";
          endTitle.textContent = `Score: ${gameState.claw1.score}`;
        }
      }

      // Réinitialiser le jeu
      function resetGame() {
        gameState.isGameOver = false;
        gameState.claw1.score = 0;
        gameState.claw2.score = 0;
        player1Score.textContent = "0";
        player2Score.textContent = "0";

        endScreen.classList.add("hidden");
        homeScreen.classList.remove("hidden");

        // Fermer les connexions PeerJS
        if (gameState.conn) {
          gameState.conn.close();
        }
        if (gameState.peer) {
          gameState.peer.destroy();
        }
      }
    </script>
  </body>
</html>
